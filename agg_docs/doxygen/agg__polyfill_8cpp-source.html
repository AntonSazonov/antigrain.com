<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.0 Transitional//EN">
<html><head><meta http-equiv="Content-Type" content="text/html;charset=iso-8859-1">
<title>agg_polyfill.cpp Source File</title>
<link href="doxygen.css" rel="stylesheet" type="text/css">
</head><body>
<!-- Generated by Doxygen 1.2.14 -->
<center>
<a class="qindex" href="index.html">Main Page</a> &nbsp; <a class="qindex" href="namespaces.html">Namespace List</a> &nbsp; <a class="qindex" href="hierarchy.html">Class Hierarchy</a> &nbsp; <a class="qindex" href="classes.html">Alphabetical List</a> &nbsp; <a class="qindex" href="annotated.html">Compound List</a> &nbsp; <a class="qindex" href="files.html">File List</a> &nbsp; <a class="qindex" href="namespacemembers.html">Namespace Members</a> &nbsp; <a class="qindex" href="functions.html">Compound Members</a> &nbsp; </center>
<hr><h1>agg_polyfill.cpp</h1><a href="agg__polyfill_8cpp.html">Go to the documentation of this file.</a><div class="fragment"><pre>00001 <font class="comment">//----------------------------------------------------------------------------</font>
00002 <font class="comment">// Anti-Grain Geometry - Version 2.0 </font>
00003 <font class="comment">// Copyright (C) 2002 Maxim Shemanarev (McSeem)</font>
00004 <font class="comment">//</font>
00005 <font class="comment">// Permission to copy, use, modify, sell and distribute this software </font>
00006 <font class="comment">// is granted provided this copyright notice appears in all copies. </font>
00007 <font class="comment">// This software is provided "as is" without express or implied</font>
00008 <font class="comment">// warranty, and with no claim as to its suitability for any purpose.</font>
00009 <font class="comment">//</font>
00010 <font class="comment">// The author gratefully acknowleges the support of David Turner, </font>
00011 <font class="comment">// Robert Wilhelm, and Werner Lemberg - the authors of the FreeType </font>
00012 <font class="comment">// libray - in producing this work. See http://www.freetype.org for details.</font>
00013 <font class="comment">//</font>
00014 <font class="comment">//----------------------------------------------------------------------------</font>
00015 <font class="comment">// Contact: mcseem@antigrain.com</font>
00016 <font class="comment">//          mcseemagg@yahoo.com</font>
00017 <font class="comment">//          http://www.antigrain.com</font>
00018 <font class="comment">//----------------------------------------------------------------------------</font>
00019 <font class="comment">//</font>
00020 <font class="comment">// Class polyfill - implementation.</font>
00021 <font class="comment">//</font>
00022 <font class="comment">// Initially the rendering algorithm was designed by David Turner and the </font>
00023 <font class="comment">// other authors of the FreeType library - see the above notice. I nearly </font>
00024 <font class="comment">// created a similar renderer, but still I was far from David's work. </font>
00025 <font class="comment">// I completely redesigned the original code and adapted it for Anti-Grain </font>
00026 <font class="comment">// ideas. Two functions - render_line and render_scanline are the core of </font>
00027 <font class="comment">// the algorithm - they calculate the exact coverage of each pixel cell</font>
00028 <font class="comment">// of the polygon. I left these functions almost as is, because there's </font>
00029 <font class="comment">// no way to improve the perfection - hats off to David and his group!</font>
00030 <font class="comment">//</font>
00031 <font class="comment">// All other code is very different from the original. </font>
00032 <font class="comment">// </font>
00033 <font class="comment">//----------------------------------------------------------------------------</font>
00034 
00035 <font class="preprocessor">#include &lt;string.h&gt;</font>
00036 <font class="preprocessor">#include "<a class="code" href="agg__polyfill_8h.html">agg_polyfill.h</a>"</font>
00037 
00038 
00039 <font class="keyword">namespace </font>agg
00040 {
00041 
00042 
00043     <font class="comment">//========================================================================</font>
00044 
00045     <font class="keyword">enum</font>
00046     {
00047         <a class="code" href="namespaceagg.html#a57a1">not_closed</a>    = 0x4000,
00048         <a class="code" href="namespaceagg.html#a57a2">sort_required</a> = 0x8000
00049     };
00050 
00051 
00052     <font class="comment">//------------------------------------------------------------------------</font>
<a name="l00053"></a><a class="code" href="classagg_1_1polyfill.html#r0">00053</a>     <font class="keywordtype">unsigned</font> <font class="keywordtype">char</font> polyfill::s_default_gamma[] = 
00054     {
00055     <font class="comment">//      0,   1,   2,   3,   4,   5,   6,   7,   8,   9,  10,  11,  12,  13,  14,  15,</font>
00056     <font class="comment">//     16,  17,  18,  19,  20,  21,  22,  23,  24,  25,  26,  27,  28,  29,  30,  31,</font>
00057     <font class="comment">//     32,  33,  34,  35,  36,  37,  38,  39,  40,  41,  42,  43,  44,  45,  46,  47,</font>
00058     <font class="comment">//     48,  49,  50,  51,  52,  53,  54,  55,  56,  57,  58,  59,  60,  61,  62,  63,</font>
00059     <font class="comment">//     64,  65,  66,  67,  68,  69,  70,  71,  72,  73,  74,  75,  76,  77,  78,  79,</font>
00060     <font class="comment">//     80,  81,  82,  83,  84,  85,  86,  87,  88,  89,  90,  91,  92,  93,  94,  95,</font>
00061     <font class="comment">//     96,  97,  98,  99, 100, 101, 102, 103, 104, 105, 106, 107, 108, 109, 110, 111,</font>
00062     <font class="comment">//    112, 113, 114, 115, 116, 117, 118, 119, 120, 121, 122, 123, 124, 125, 126, 127,</font>
00063     <font class="comment">//    128, 129, 130, 131, 132, 133, 134, 135, 136, 137, 138, 139, 140, 141, 142, 143,</font>
00064     <font class="comment">//    144, 145, 146, 147, 148, 149, 150, 151, 152, 153, 154, 155, 156, 157, 158, 159,</font>
00065     <font class="comment">//    160, 161, 162, 163, 164, 165, 166, 167, 168, 169, 170, 171, 172, 173, 174, 175,</font>
00066     <font class="comment">//    176, 177, 178, 179, 180, 181, 182, 183, 184, 185, 186, 187, 188, 189, 190, 191,</font>
00067     <font class="comment">//    192, 193, 194, 195, 196, 197, 198, 199, 200, 201, 202, 203, 204, 205, 206, 207,</font>
00068     <font class="comment">//    208, 209, 210, 211, 212, 213, 214, 215, 216, 217, 218, 219, 220, 221, 222, 223,</font>
00069     <font class="comment">//    224, 225, 226, 227, 228, 229, 230, 231, 232, 233, 234, 235, 236, 237, 238, 239,</font>
00070     <font class="comment">//    240, 241, 242, 243, 244, 245, 246, 247, 248, 249, 250, 251, 252, 253, 254, 255</font>
00071           0,  0,  1,  1,  2,  2,  3,  4,  4,  5,  5,  6,  7,  7,  8,  8,
00072           9, 10, 10, 11, 11, 12, 13, 13, 14, 14, 15, 16, 16, 17, 18, 18,
00073          19, 19, 20, 21, 21, 22, 22, 23, 24, 24, 25, 25, 26, 27, 27, 28,
00074          29, 29, 30, 30, 31, 32, 32, 33, 34, 34, 35, 36, 36, 37, 37, 38,
00075          39, 39, 40, 41, 41, 42, 43, 43, 44, 45, 45, 46, 47, 47, 48, 49,
00076          49, 50, 51, 51, 52, 53, 53, 54, 55, 55, 56, 57, 57, 58, 59, 60,
00077          60, 61, 62, 62, 63, 64, 65, 65, 66, 67, 68, 68, 69, 70, 71, 71,
00078          72, 73, 74, 74, 75, 76, 77, 78, 78, 79, 80, 81, 82, 83, 83, 84,
00079          85, 86, 87, 88, 89, 89, 90, 91, 92, 93, 94, 95, 96, 97, 98, 99,
00080         100,101,101,102,103,104,105,106,107,108,109,110,111,112,114,115,
00081         116,117,118,119,120,121,122,123,124,126,127,128,129,130,131,132,
00082         134,135,136,137,139,140,141,142,144,145,146,147,149,150,151,153,
00083         154,155,157,158,159,161,162,164,165,166,168,169,171,172,174,175,
00084         177,178,180,181,183,184,186,188,189,191,192,194,195,197,199,200,
00085         202,204,205,207,209,210,212,214,215,217,219,220,222,224,225,227,
00086         229,230,232,234,236,237,239,241,242,244,246,248,249,251,253,255
00087     };
00088 
00089 
00090     <font class="comment">//------------------------------------------------------------------------</font>
<a name="l00091"></a><a class="code" href="classagg_1_1polyfill.html#a0">00091</a>     polyfill::~polyfill()
00092     {
00093         <font class="keyword">delete</font> [] <a class="code" href="classagg_1_1polyfill.html#o6">m_sorted_cells</a>;
00094         <font class="keywordflow">if</font>(m_num_blocks)
00095         {
00096             cell** ptr = <a class="code" href="classagg_1_1polyfill.html#o4">m_cells</a> + <a class="code" href="classagg_1_1polyfill.html#o0">m_num_blocks</a> - 1;
00097             <font class="keywordflow">while</font>(<a class="code" href="classagg_1_1polyfill.html#o0">m_num_blocks</a>--)
00098             {
00099                 <font class="keyword">delete</font> [] *ptr;
00100                 ptr--;
00101             }
00102             <font class="keyword">delete</font> [] <a class="code" href="classagg_1_1polyfill.html#o4">m_cells</a>;
00103         }
00104     }
00105 
00106 
00107     <font class="comment">//------------------------------------------------------------------------</font>
<a name="l00108"></a><a class="code" href="classagg_1_1polyfill.html#a1">00108</a>     polyfill::polyfill() :
00109         m_num_blocks(0),
00110         m_max_blocks(0),
00111         m_cur_block(0),
00112         m_num_cells(0),
00113         m_cells(0),
00114         m_cur_cell_ptr(0),
00115         m_sorted_cells(0),
00116         m_sorted_size(0),
00117         m_flags(<a class="code" href="namespaceagg.html#a57a2">sort_required</a>),
00118         m_gamma(s_default_gamma),
00119         m_min_x(0x7FFFFFFF),
00120         m_max_x(-0x7FFFFFFF)
00121     {
00122         <a class="code" href="classagg_1_1polyfill.html#o10">m_cur_cell</a>.set_cover(0, 0);
00123     }
00124 
00125 
00126     <font class="comment">//------------------------------------------------------------------------</font>
<a name="l00127"></a><a class="code" href="classagg_1_1polyfill.html#a4">00127</a>     <font class="keywordtype">void</font> polyfill::reset()
00128     { 
00129         <a class="code" href="classagg_1_1polyfill.html#o3">m_num_cells</a> = 0; 
00130         <a class="code" href="classagg_1_1polyfill.html#o2">m_cur_block</a> = 0;
00131         <a class="code" href="classagg_1_1polyfill.html#o10">m_cur_cell</a>.set_cover(0, 0);
00132         <a class="code" href="classagg_1_1polyfill.html#o8">m_flags</a> |= <a class="code" href="namespaceagg.html#a57a2">sort_required</a>;
00133         <a class="code" href="classagg_1_1polyfill.html#o8">m_flags</a> &amp;= ~<a class="code" href="namespaceagg.html#a57a1">not_closed</a>;
00134         <a class="code" href="classagg_1_1polyfill.html#o15">m_min_x</a> =  0x7FFFFFFF;
00135         <a class="code" href="classagg_1_1polyfill.html#o16">m_max_x</a> = -0x7FFFFFFF;
00136     }
00137 
00138 
00139     <font class="comment">//------------------------------------------------------------------------</font>
<a name="l00140"></a><a class="code" href="classagg_1_1polyfill.html#a2">00140</a>     <font class="keywordtype">void</font> polyfill::set_flags(<font class="keywordtype">unsigned</font> flags)
00141     {
00142         <a class="code" href="classagg_1_1polyfill.html#o8">m_flags</a> = (<a class="code" href="classagg_1_1polyfill.html#o8">m_flags</a> &amp; 0xFFFFFF00) | (flags &amp; 0xFF);
00143     }
00144 
00145 
00146     <font class="comment">//------------------------------------------------------------------------</font>
<a name="l00147"></a><a class="code" href="classagg_1_1polyfill.html#a3">00147</a>     <font class="keywordtype">void</font> polyfill::set_gamma(<font class="keyword">const</font> <font class="keywordtype">unsigned</font> <font class="keywordtype">char</font>* gamma)
00148     {
00149         <a class="code" href="classagg_1_1polyfill.html#o9">m_gamma</a> = gamma;
00150         <font class="keywordflow">if</font>(<a class="code" href="classagg_1_1polyfill.html#o9">m_gamma</a> == 0) <a class="code" href="classagg_1_1polyfill.html#o9">m_gamma</a> = <a class="code" href="classagg_1_1polyfill.html#r0">s_default_gamma</a>;
00151     }
00152 
00153 
00154     <font class="comment">//------------------------------------------------------------------------</font>
<a name="l00155"></a><a class="code" href="classagg_1_1polyfill.html#c8">00155</a>     <font class="keywordtype">void</font> polyfill::allocate_block()
00156     {
00157         <font class="keywordflow">if</font>(<a class="code" href="classagg_1_1polyfill.html#o2">m_cur_block</a> &gt;= <a class="code" href="classagg_1_1polyfill.html#o0">m_num_blocks</a>)
00158         {
00159             <font class="keywordflow">if</font>(<a class="code" href="classagg_1_1polyfill.html#o0">m_num_blocks</a> &gt;= <a class="code" href="classagg_1_1polyfill.html#o1">m_max_blocks</a>)
00160             {
00161                 cell** new_cells = <font class="keyword">new</font> cell* [<a class="code" href="classagg_1_1polyfill.html#o1">m_max_blocks</a> + <a class="code" href="classagg_1_1polyfill.html#u5u3">cell_block_pool</a>];
00162                 <font class="keywordflow">if</font>(m_cells)
00163                 {
00164                     memcpy(new_cells, <a class="code" href="classagg_1_1polyfill.html#o4">m_cells</a>, <a class="code" href="classagg_1_1polyfill.html#o1">m_max_blocks</a> * <font class="keyword">sizeof</font>(cell*));
00165                     <font class="keyword">delete</font> [] <a class="code" href="classagg_1_1polyfill.html#o4">m_cells</a>;
00166                 }
00167                 <a class="code" href="classagg_1_1polyfill.html#o4">m_cells</a> = new_cells;
00168                 <a class="code" href="classagg_1_1polyfill.html#o1">m_max_blocks</a> += <a class="code" href="classagg_1_1polyfill.html#u5u3">cell_block_pool</a>;
00169             }
00170             <a class="code" href="classagg_1_1polyfill.html#o4">m_cells</a>[<a class="code" href="classagg_1_1polyfill.html#o0">m_num_blocks</a>++] = <font class="keyword">new</font> cell [unsigned(<a class="code" href="classagg_1_1polyfill.html#u5u1">cell_block_size</a>)];
00171         }
00172         <a class="code" href="classagg_1_1polyfill.html#o5">m_cur_cell_ptr</a> = <a class="code" href="classagg_1_1polyfill.html#o4">m_cells</a>[<a class="code" href="classagg_1_1polyfill.html#o2">m_cur_block</a>++];
00173     }
00174 
00175 
00176     <font class="comment">//------------------------------------------------------------------------</font>
<a name="l00177"></a><a class="code" href="structagg_1_1cell.html#a2">00177</a>     <font class="keyword">inline</font> <font class="keywordtype">void</font> cell::set_cover(<font class="keywordtype">int</font> c, <font class="keywordtype">int</font> a)
00178     {
00179         <a class="code" href="structagg_1_1cell.html#m3">cover</a> = c;
00180         <a class="code" href="structagg_1_1cell.html#m4">area</a> = a;
00181     }
00182 
00183     <font class="comment">//------------------------------------------------------------------------</font>
<a name="l00184"></a><a class="code" href="structagg_1_1cell.html#a3">00184</a>     <font class="keyword">inline</font> <font class="keywordtype">void</font> cell::add_cover(<font class="keywordtype">int</font> c, <font class="keywordtype">int</font> a)
00185     {
00186         <a class="code" href="structagg_1_1cell.html#m3">cover</a> += c;
00187         <a class="code" href="structagg_1_1cell.html#m4">area</a> += a;
00188     }
00189 
00190     <font class="comment">//------------------------------------------------------------------------</font>
<a name="l00191"></a><a class="code" href="structagg_1_1cell.html#a1">00191</a>     <font class="keyword">inline</font> <font class="keywordtype">void</font> cell::set_coord(<font class="keywordtype">int</font> cx, <font class="keywordtype">int</font> cy)
00192     {
00193         <a class="code" href="structagg_1_1cell.html#m0">x</a> = <a class="code" href="namespaceagg.html#a6">int16</a>(cx);
00194         <a class="code" href="structagg_1_1cell.html#m1">y</a> = <a class="code" href="namespaceagg.html#a6">int16</a>(cy);
00195         <a class="code" href="structagg_1_1cell.html#m2">packed_coord</a> = (cy &lt;&lt; 16) + cx;
00196     }
00197 
00198     <font class="comment">//------------------------------------------------------------------------</font>
<a name="l00199"></a><a class="code" href="structagg_1_1cell.html#a0">00199</a>     <font class="keyword">inline</font> <font class="keywordtype">void</font> cell::set(<font class="keywordtype">int</font> cx, <font class="keywordtype">int</font> cy, <font class="keywordtype">int</font> c, <font class="keywordtype">int</font> a)
00200     {
00201         <a class="code" href="structagg_1_1cell.html#m0">x</a> = <a class="code" href="namespaceagg.html#a6">int16</a>(cx);
00202         <a class="code" href="structagg_1_1cell.html#m1">y</a> = <a class="code" href="namespaceagg.html#a6">int16</a>(cy);
00203         <a class="code" href="structagg_1_1cell.html#m2">packed_coord</a> = (cy &lt;&lt; 16) + cx;
00204         <a class="code" href="structagg_1_1cell.html#m3">cover</a> = c;
00205         <a class="code" href="structagg_1_1cell.html#m4">area</a> = a;
00206     }
00207 
00208     <font class="comment">//------------------------------------------------------------------------</font>
<a name="l00209"></a><a class="code" href="classagg_1_1polyfill.html#c3">00209</a>     <font class="keyword">inline</font> <font class="keywordtype">void</font> polyfill::add_cur_cell()
00210     {
00211         <font class="keywordflow">if</font>(<a class="code" href="classagg_1_1polyfill.html#o10">m_cur_cell</a>.area | <a class="code" href="classagg_1_1polyfill.html#o10">m_cur_cell</a>.cover)
00212         {
00213             <font class="keywordflow">if</font>((<a class="code" href="classagg_1_1polyfill.html#o3">m_num_cells</a> &amp; <a class="code" href="classagg_1_1polyfill.html#u5u2">cell_block_mask</a>) == 0)
00214             {
00215                 <font class="keywordflow">if</font>(<a class="code" href="classagg_1_1polyfill.html#o0">m_num_blocks</a> &gt;= <a class="code" href="classagg_1_1polyfill.html#u5u4">cell_block_limit</a>) <font class="keywordflow">return</font>;
00216                 <a class="code" href="classagg_1_1polyfill.html#c8">allocate_block</a>();
00217             }
00218             *<a class="code" href="classagg_1_1polyfill.html#o5">m_cur_cell_ptr</a>++ = <a class="code" href="classagg_1_1polyfill.html#o10">m_cur_cell</a>;
00219             <a class="code" href="classagg_1_1polyfill.html#o3">m_num_cells</a>++;
00220         }
00221     }
00222 
00223 
00224 
00225     <font class="comment">//------------------------------------------------------------------------</font>
<a name="l00226"></a><a class="code" href="classagg_1_1polyfill.html#c2">00226</a>     <font class="keyword">inline</font> <font class="keywordtype">void</font> polyfill::set_cur_cell(<font class="keywordtype">int</font> x, <font class="keywordtype">int</font> y)
00227     {
00228         <font class="keywordflow">if</font>(<a class="code" href="classagg_1_1polyfill.html#o10">m_cur_cell</a>.packed_coord != (y &lt;&lt; 16) + x)
00229         {
00230             <a class="code" href="classagg_1_1polyfill.html#c3">add_cur_cell</a>();
00231             <a class="code" href="classagg_1_1polyfill.html#o10">m_cur_cell</a>.set(x, y, 0, 0);
00232         }
00233     }
00234 
00235 
00236 
00237     <font class="comment">//------------------------------------------------------------------------</font>
<a name="l00238"></a><a class="code" href="classagg_1_1polyfill.html#c5">00238</a>     <font class="keyword">inline</font> <font class="keywordtype">void</font> polyfill::render_scanline(<font class="keywordtype">int</font> ey, <font class="keywordtype">int</font> x1, <font class="keywordtype">int</font> y1, <font class="keywordtype">int</font> x2, <font class="keywordtype">int</font> y2)
00239     {
00240         <font class="keywordtype">int</font> ex1 = x1 &gt;&gt; <a class="code" href="namespaceagg.html#a59a11">poly_base_shift</a>;
00241         <font class="keywordtype">int</font> ex2 = x2 &gt;&gt; <a class="code" href="namespaceagg.html#a59a11">poly_base_shift</a>;
00242         <font class="keywordtype">int</font> fx1 = x1 &amp; <a class="code" href="namespaceagg.html#a59a13">poly_base_mask</a>;
00243         <font class="keywordtype">int</font> fx2 = x2 &amp; <a class="code" href="namespaceagg.html#a59a13">poly_base_mask</a>;
00244 
00245         <font class="keywordtype">int</font> delta, p, first, dx;
00246         <font class="keywordtype">int</font> incr, lift, mod, rem;
00247 
00248         <font class="comment">//trivial case. Happens often</font>
00249         <font class="keywordflow">if</font>(y1 == y2)
00250         {
00251             <a class="code" href="classagg_1_1polyfill.html#c2">set_cur_cell</a>(ex2, ey);
00252             <font class="keywordflow">return</font>;
00253         }
00254 
00255         <font class="comment">//everything is located in a single cell.  That is easy!</font>
00256         <font class="keywordflow">if</font>(ex1 == ex2)
00257         {
00258             delta = y2 - y1;
00259             <a class="code" href="classagg_1_1polyfill.html#o10">m_cur_cell</a>.add_cover(delta, (fx1 + fx2) * delta);
00260             <font class="keywordflow">return</font>;
00261         }
00262 
00263         <font class="comment">//ok, we'll have to render a run of adjacent cells on the same</font>
00264         <font class="comment">//scanline...</font>
00265         p     = (<a class="code" href="namespaceagg.html#a59a12">poly_base_size</a> - fx1) * (y2 - y1);
00266         first = <a class="code" href="namespaceagg.html#a59a12">poly_base_size</a>;
00267         incr  = 1;
00268 
00269         dx = x2 - x1;
00270 
00271         <font class="keywordflow">if</font>(dx &lt; 0)
00272         {
00273             p     = fx1 * (y2 - y1);
00274             first = 0;
00275             incr  = -1;
00276             dx    = -dx;
00277         }
00278 
00279         delta = p / dx;
00280         mod   = p % dx;
00281 
00282         <font class="keywordflow">if</font>(mod &lt; 0)
00283         {
00284             delta--;
00285             mod += dx;
00286         }
00287 
00288         <a class="code" href="classagg_1_1polyfill.html#o10">m_cur_cell</a>.add_cover(delta, (fx1 + first) * delta);
00289 
00290         ex1 += incr;
00291         <a class="code" href="classagg_1_1polyfill.html#c2">set_cur_cell</a>(ex1, ey);
00292         y1  += delta;
00293 
00294         <font class="keywordflow">if</font>(ex1 != ex2)
00295         {
00296             p     = <a class="code" href="namespaceagg.html#a59a12">poly_base_size</a> * (y2 - y1 + delta);
00297             lift  = p / dx;
00298             rem   = p % dx;
00299 
00300             <font class="keywordflow">if</font> (rem &lt; 0)
00301             {
00302                 lift--;
00303                 rem += dx;
00304             }
00305 
00306             mod -= dx;
00307 
00308             <font class="keywordflow">while</font> (ex1 != ex2)
00309             {
00310                 delta = lift;
00311                 mod  += rem;
00312                 <font class="keywordflow">if</font>(mod &gt;= 0)
00313                 {
00314                     mod -= dx;
00315                     delta++;
00316                 }
00317 
00318                 <a class="code" href="classagg_1_1polyfill.html#o10">m_cur_cell</a>.add_cover(delta, (<a class="code" href="namespaceagg.html#a59a12">poly_base_size</a>) * delta);
00319                 y1  += delta;
00320                 ex1 += incr;
00321                 <a class="code" href="classagg_1_1polyfill.html#c2">set_cur_cell</a>(ex1, ey);
00322             }
00323         }
00324         delta = y2 - y1;
00325         <a class="code" href="classagg_1_1polyfill.html#o10">m_cur_cell</a>.add_cover(delta, (fx2 + <a class="code" href="namespaceagg.html#a59a12">poly_base_size</a> - first) * delta);
00326     }
00327 
00328 
00329 
00330 
00331 
00332 
00333     <font class="comment">//------------------------------------------------------------------------</font>
<a name="l00334"></a><a class="code" href="classagg_1_1polyfill.html#c6">00334</a>     <font class="keywordtype">void</font> polyfill::render_line(<font class="keywordtype">int</font> x1, <font class="keywordtype">int</font> y1, <font class="keywordtype">int</font> x2, <font class="keywordtype">int</font> y2)
00335     {
00336         <font class="keywordtype">int</font> ey1 = y1 &gt;&gt; <a class="code" href="namespaceagg.html#a59a11">poly_base_shift</a>;
00337         <font class="keywordtype">int</font> ey2 = y2 &gt;&gt; <a class="code" href="namespaceagg.html#a59a11">poly_base_shift</a>;
00338         <font class="keywordtype">int</font> fy1 = y1 &amp; <a class="code" href="namespaceagg.html#a59a13">poly_base_mask</a>;
00339         <font class="keywordtype">int</font> fy2 = y2 &amp; <a class="code" href="namespaceagg.html#a59a13">poly_base_mask</a>;
00340 
00341         <font class="keywordtype">int</font> dx, dy, x_from, x_to;
00342         <font class="keywordtype">int</font> p, rem, mod, lift, delta, first, incr;
00343 
00344         dx = x2 - x1;
00345         dy = y2 - y1;
00346 
00347         <font class="comment">//everything is on a single scanline</font>
00348         <font class="keywordflow">if</font>(ey1 == ey2)
00349         {
00350             <a class="code" href="classagg_1_1polyfill.html#c5">render_scanline</a>(ey1, x1, fy1, x2, fy2);
00351             <font class="keywordflow">return</font>;
00352         }
00353 
00354         <font class="comment">//Vertical line - we have to calculate start and end cells,</font>
00355         <font class="comment">//and then - the common values of the area and coverage for</font>
00356         <font class="comment">//all cells of the line. We know exactly there's only one </font>
00357         <font class="comment">//cell, so, we don't have to call render_scanline().</font>
00358         incr  = 1;
00359         <font class="keywordflow">if</font>(dx == 0)
00360         {
00361             <font class="keywordtype">int</font> ex = x1 &gt;&gt; <a class="code" href="namespaceagg.html#a59a11">poly_base_shift</a>;
00362             <font class="keywordtype">int</font> two_fx = (x1 - (ex &lt;&lt; <a class="code" href="namespaceagg.html#a59a11">poly_base_shift</a>)) &lt;&lt; 1;
00363             <font class="keywordtype">int</font> area;
00364 
00365             first = <a class="code" href="namespaceagg.html#a59a12">poly_base_size</a>;
00366             <font class="keywordflow">if</font>(dy &lt; 0)
00367             {
00368                 first = 0;
00369                 incr  = -1;
00370             }
00371 
00372             x_from = x1;
00373 
00374             <font class="comment">//render_scanline(ey1, x_from, fy1, x_from, first);</font>
00375             delta = first - fy1;
00376             <a class="code" href="classagg_1_1polyfill.html#o10">m_cur_cell</a>.add_cover(delta, two_fx * delta);
00377 
00378             ey1 += incr;
00379             <a class="code" href="classagg_1_1polyfill.html#c2">set_cur_cell</a>(ex, ey1);
00380 
00381             delta = first + first - <a class="code" href="namespaceagg.html#a59a12">poly_base_size</a>;
00382             area = two_fx * delta;
00383             <font class="keywordflow">while</font>(ey1 != ey2)
00384             {
00385                 <font class="comment">//render_scanline(ey1, x_from, poly_base_size - first, x_from, first);</font>
00386                 <a class="code" href="classagg_1_1polyfill.html#o10">m_cur_cell</a>.set_cover(delta, area);
00387                 ey1 += incr;
00388                 <a class="code" href="classagg_1_1polyfill.html#c2">set_cur_cell</a>(ex, ey1);
00389             }
00390             <font class="comment">//render_scanline(ey1, x_from, poly_base_size - first, x_from, fy2);</font>
00391             delta = fy2 - <a class="code" href="namespaceagg.html#a59a12">poly_base_size</a> + first;
00392             <a class="code" href="classagg_1_1polyfill.html#o10">m_cur_cell</a>.add_cover(delta, two_fx * delta);
00393             <font class="keywordflow">return</font>;
00394         }
00395 
00396         <font class="comment">//ok, we have to render several scanlines</font>
00397         p     = (<a class="code" href="namespaceagg.html#a59a12">poly_base_size</a> - fy1) * dx;
00398         first = <a class="code" href="namespaceagg.html#a59a12">poly_base_size</a>;
00399 
00400         <font class="keywordflow">if</font>(dy &lt; 0)
00401         {
00402             p     = fy1 * dx;
00403             first = 0;
00404             incr  = -1;
00405             dy    = -dy;
00406         }
00407 
00408         delta = p / dy;
00409         mod   = p % dy;
00410 
00411         <font class="keywordflow">if</font>(mod &lt; 0)
00412         {
00413             delta--;
00414             mod += dy;
00415         }
00416 
00417         x_from = x1 + delta;
00418         <a class="code" href="classagg_1_1polyfill.html#c5">render_scanline</a>(ey1, x1, fy1, x_from, first);
00419 
00420         ey1 += incr;
00421         <a class="code" href="classagg_1_1polyfill.html#c2">set_cur_cell</a>(x_from &gt;&gt; <a class="code" href="namespaceagg.html#a59a11">poly_base_shift</a>, ey1);
00422 
00423         <font class="keywordflow">if</font>(ey1 != ey2)
00424         {
00425             p     = <a class="code" href="namespaceagg.html#a59a12">poly_base_size</a> * dx;
00426             lift  = p / dy;
00427             rem   = p % dy;
00428 
00429             <font class="keywordflow">if</font>(rem &lt; 0)
00430             {
00431                 lift--;
00432                 rem += dy;
00433             }
00434             mod -= dy;
00435 
00436             <font class="keywordflow">while</font>(ey1 != ey2)
00437             {
00438                 delta = lift;
00439                 mod  += rem;
00440                 <font class="keywordflow">if</font> (mod &gt;= 0)
00441                 {
00442                     mod -= dy;
00443                     delta++;
00444                 }
00445 
00446                 x_to = x_from + delta;
00447                 <a class="code" href="classagg_1_1polyfill.html#c5">render_scanline</a>(ey1, x_from, <a class="code" href="namespaceagg.html#a59a12">poly_base_size</a> - first, x_to, first);
00448                 x_from = x_to;
00449 
00450                 ey1 += incr;
00451                 <a class="code" href="classagg_1_1polyfill.html#c2">set_cur_cell</a>(x_from &gt;&gt; <a class="code" href="namespaceagg.html#a59a11">poly_base_shift</a>, ey1);
00452             }
00453         }
00454         <a class="code" href="classagg_1_1polyfill.html#c5">render_scanline</a>(ey1, x_from, <a class="code" href="namespaceagg.html#a59a12">poly_base_size</a> - first, x2, fy2);
00455     }
00456 
00457 
00458     <font class="comment">//------------------------------------------------------------------------</font>
<a name="l00459"></a><a class="code" href="classagg_1_1polyfill.html#a5">00459</a>     <font class="keywordtype">void</font> polyfill::move_to(<font class="keywordtype">int</font> x, <font class="keywordtype">int</font> y)
00460     {
00461         <font class="keywordflow">if</font>((<a class="code" href="classagg_1_1polyfill.html#o8">m_flags</a> &amp; <a class="code" href="namespaceagg.html#a57a2">sort_required</a>) == 0) <a class="code" href="classagg_1_1polyfill.html#a4">reset</a>();
00462         <font class="keywordflow">if</font>(<a class="code" href="classagg_1_1polyfill.html#o8">m_flags</a> &amp; <a class="code" href="namespaceagg.html#a57a1">not_closed</a>) <a class="code" href="classagg_1_1polyfill.html#a6">line_to</a>(<a class="code" href="classagg_1_1polyfill.html#o13">m_close_x</a>, <a class="code" href="classagg_1_1polyfill.html#o14">m_close_y</a>);
00463         <font class="keywordtype">int</font> ex = x &gt;&gt; <a class="code" href="namespaceagg.html#a59a11">poly_base_shift</a>;
00464         <a class="code" href="classagg_1_1polyfill.html#c2">set_cur_cell</a>(ex, y &gt;&gt; <a class="code" href="namespaceagg.html#a59a11">poly_base_shift</a>);
00465         <a class="code" href="classagg_1_1polyfill.html#o13">m_close_x</a> = <a class="code" href="classagg_1_1polyfill.html#o11">m_cur_x</a> = x;
00466         <a class="code" href="classagg_1_1polyfill.html#o14">m_close_y</a> = <a class="code" href="classagg_1_1polyfill.html#o12">m_cur_y</a> = y;
00467         <font class="keywordflow">if</font>(ex &lt; <a class="code" href="classagg_1_1polyfill.html#o15">m_min_x</a>) <a class="code" href="classagg_1_1polyfill.html#o15">m_min_x</a> = ex;
00468         ++ex;
00469         <font class="keywordflow">if</font>(ex &gt; <a class="code" href="classagg_1_1polyfill.html#o16">m_max_x</a>) <a class="code" href="classagg_1_1polyfill.html#o16">m_max_x</a> = ex;
00470     }
00471 
00472 
00473     <font class="comment">//------------------------------------------------------------------------</font>
<a name="l00474"></a><a class="code" href="classagg_1_1polyfill.html#a6">00474</a>     <font class="keywordtype">void</font> polyfill::line_to(<font class="keywordtype">int</font> x, <font class="keywordtype">int</font> y)
00475     {
00476         <font class="keywordflow">if</font>(<a class="code" href="classagg_1_1polyfill.html#o8">m_flags</a> &amp; <a class="code" href="namespaceagg.html#a57a2">sort_required</a>)
00477         {
00478             <a class="code" href="classagg_1_1polyfill.html#c6">render_line</a>(<a class="code" href="classagg_1_1polyfill.html#o11">m_cur_x</a>, <a class="code" href="classagg_1_1polyfill.html#o12">m_cur_y</a>, x, y);
00479             <a class="code" href="classagg_1_1polyfill.html#o11">m_cur_x</a> = x;
00480             <a class="code" href="classagg_1_1polyfill.html#o12">m_cur_y</a> = y;
00481             <a class="code" href="classagg_1_1polyfill.html#o8">m_flags</a> |= <a class="code" href="namespaceagg.html#a57a1">not_closed</a>;
00482             <font class="keywordtype">int</font> ex = x &gt;&gt; <a class="code" href="namespaceagg.html#a59a11">poly_base_shift</a>;
00483             <font class="keywordflow">if</font>(ex &lt; <a class="code" href="classagg_1_1polyfill.html#o15">m_min_x</a>) <a class="code" href="classagg_1_1polyfill.html#o15">m_min_x</a> = ex;
00484             ++ex;
00485             <font class="keywordflow">if</font>(ex &gt; <a class="code" href="classagg_1_1polyfill.html#o16">m_max_x</a>) <a class="code" href="classagg_1_1polyfill.html#o16">m_max_x</a> = ex;
00486         }
00487     }
00488 
00489 
00490     <font class="keyword">enum</font>
00491     {
00492         <a class="code" href="namespaceagg.html#a58a3">qsort_threshold</a> = 9
00493     };
00494 
00495 
00496     <font class="comment">//------------------------------------------------------------------------</font>
00497     <font class="keyword">template</font> &lt;<font class="keyword">class</font> T&gt; <font class="keyword">static</font> <font class="keyword">inline</font> <font class="keywordtype">void</font> <a class="code" href="namespaceagg.html#a37">swap_cells</a>(T* a, T* b)
00498     {
00499         T temp = *a;
00500         *a = *b;
00501         *b = temp;
00502     }
00503 
00504     <font class="comment">//------------------------------------------------------------------------</font>
00505     <font class="keyword">template</font> &lt;<font class="keyword">class</font> T&gt; <font class="keyword">static</font> <font class="keyword">inline</font> <font class="keywordtype">bool</font> <a class="code" href="namespaceagg.html#a38">less_than</a>(T* a, T* b)
00506     {
00507         <font class="keywordflow">return</font> (*a)-&gt;packed_coord &lt; (*b)-&gt;packed_coord;
00508     }
00509 
00510 
00511 
00512     <font class="comment">//------------------------------------------------------------------------</font>
<a name="l00513"></a><a class="code" href="classagg_1_1polyfill.html#f0">00513</a>     <font class="keywordtype">void</font> polyfill::cell_qsort(cell** start, <font class="keywordtype">unsigned</font> num)
00514     {
00515         cell**  stack[80];
00516         cell*** top; 
00517         cell**  limit;
00518         cell**  base;
00519 
00520         limit = start + num;
00521         base  = start;
00522         top   = stack;
00523 
00524         <font class="keywordflow">for</font> (;;)
00525         {
00526             <font class="keywordtype">int</font> len = int(limit - base);
00527 
00528             cell** i;
00529             cell** j;
00530             cell** pivot;
00531 
00532             <font class="keywordflow">if</font>(len &gt; <a class="code" href="namespaceagg.html#a58a3">qsort_threshold</a>)
00533             {
00534                 <font class="comment">// we use base + len/2 as the pivot</font>
00535                 pivot = base + len / 2;
00536                 <a class="code" href="namespaceagg.html#a37">swap_cells</a>(base, pivot);
00537 
00538                 i = base + 1;
00539                 j = limit - 1;
00540 
00541                 <font class="comment">// now ensure that *i &lt;= *base &lt;= *j </font>
00542                 <font class="keywordflow">if</font>(<a class="code" href="namespaceagg.html#a38">less_than</a>(j, i))
00543                 {
00544                     <a class="code" href="namespaceagg.html#a37">swap_cells</a>(i, j);
00545                 }
00546 
00547                 <font class="keywordflow">if</font>(<a class="code" href="namespaceagg.html#a38">less_than</a>(base, i))
00548                 {
00549                     <a class="code" href="namespaceagg.html#a37">swap_cells</a>(base, i);
00550                 }
00551 
00552                 <font class="keywordflow">if</font>(<a class="code" href="namespaceagg.html#a38">less_than</a>(j, base))
00553                 {
00554                     <a class="code" href="namespaceagg.html#a37">swap_cells</a>(base, j);
00555                 }
00556 
00557                 <font class="keywordflow">for</font>(;;)
00558                 {
00559                     <font class="keywordflow">do</font> i++; <font class="keywordflow">while</font>( <a class="code" href="namespaceagg.html#a38">less_than</a>(i, base) );
00560                     <font class="keywordflow">do</font> j--; <font class="keywordflow">while</font>( <a class="code" href="namespaceagg.html#a38">less_than</a>(base, j) );
00561 
00562                     <font class="keywordflow">if</font> ( i &gt; j )
00563                     {
00564                         <font class="keywordflow">break</font>;
00565                     }
00566 
00567                     <a class="code" href="namespaceagg.html#a37">swap_cells</a>(i, j);
00568                 }
00569 
00570                 <a class="code" href="namespaceagg.html#a37">swap_cells</a>(base, j);
00571 
00572                 <font class="comment">// now, push the largest sub-array</font>
00573                 <font class="keywordflow">if</font>(j - base &gt; limit - i)
00574                 {
00575                     top[0] = base;
00576                     top[1] = j;
00577                     base   = i;
00578                 }
00579                 <font class="keywordflow">else</font>
00580                 {
00581                     top[0] = i;
00582                     top[1] = limit;
00583                     limit  = j;
00584                 }
00585                 top += 2;
00586             }
00587             <font class="keywordflow">else</font>
00588             {
00589                 <font class="comment">// the sub-array is small, perform insertion sort</font>
00590                 j = base;
00591                 i = j + 1;
00592 
00593                 <font class="keywordflow">for</font>(; i &lt; limit; j = i, i++)
00594                 {
00595                     <font class="keywordflow">for</font>(; <a class="code" href="namespaceagg.html#a38">less_than</a>(j + 1, j); j--)
00596                     {
00597                         <a class="code" href="namespaceagg.html#a37">swap_cells</a>(j + 1, j);
00598                         <font class="keywordflow">if</font> (j == base)
00599                         {
00600                             <font class="keywordflow">break</font>;
00601                         }
00602                     }
00603                 }
00604                 <font class="keywordflow">if</font>(top &gt; stack)
00605                 {
00606                     top  -= 2;
00607                     base  = top[0];
00608                     limit = top[1];
00609                 }
00610                 <font class="keywordflow">else</font>
00611                 {
00612                     <font class="keywordflow">break</font>;
00613                 }
00614             }
00615         }
00616     }
00617 
00618 
00619 
00620 
00621 
00622     <font class="comment">//------------------------------------------------------------------------</font>
<a name="l00623"></a><a class="code" href="classagg_1_1polyfill.html#c4">00623</a>     <font class="keywordtype">void</font> polyfill::sort_cells()
00624     {
00625         <font class="keywordflow">if</font>(<a class="code" href="classagg_1_1polyfill.html#o3">m_num_cells</a> == 0) <font class="keywordflow">return</font>;
00626 
00627         <font class="keywordflow">if</font>(<a class="code" href="classagg_1_1polyfill.html#o3">m_num_cells</a> &gt; <a class="code" href="classagg_1_1polyfill.html#o7">m_sorted_size</a>)
00628         {
00629             <font class="keyword">delete</font> [] <a class="code" href="classagg_1_1polyfill.html#o6">m_sorted_cells</a>;
00630             <a class="code" href="classagg_1_1polyfill.html#o7">m_sorted_size</a> = <a class="code" href="classagg_1_1polyfill.html#o3">m_num_cells</a>;
00631             <a class="code" href="classagg_1_1polyfill.html#o6">m_sorted_cells</a> = <font class="keyword">new</font> cell* [<a class="code" href="classagg_1_1polyfill.html#o3">m_num_cells</a> + 1];
00632         }
00633 
00634         cell** sorted_ptr = <a class="code" href="classagg_1_1polyfill.html#o6">m_sorted_cells</a>;
00635         cell** block_ptr = <a class="code" href="classagg_1_1polyfill.html#o4">m_cells</a>;
00636         cell*  cell_ptr;
00637 
00638         <font class="keywordtype">unsigned</font> nb = <a class="code" href="classagg_1_1polyfill.html#o3">m_num_cells</a> &gt;&gt; <a class="code" href="classagg_1_1polyfill.html#u5u0">cell_block_shift</a>;
00639         <font class="keywordtype">unsigned</font> i;
00640 
00641         <font class="keywordflow">while</font>(nb--)
00642         {
00643             cell_ptr = *block_ptr++;
00644             i = <a class="code" href="classagg_1_1polyfill.html#u5u1">cell_block_size</a>;
00645             <font class="keywordflow">while</font>(i--) 
00646             {
00647                 *sorted_ptr++ = cell_ptr++;
00648             }
00649         }
00650 
00651         cell_ptr = *block_ptr++;
00652         i = <a class="code" href="classagg_1_1polyfill.html#o3">m_num_cells</a> &amp; <a class="code" href="classagg_1_1polyfill.html#u5u2">cell_block_mask</a>;
00653         <font class="keywordflow">while</font>(i--) 
00654         {
00655             *sorted_ptr++ = cell_ptr++;
00656         }
00657         <a class="code" href="classagg_1_1polyfill.html#o6">m_sorted_cells</a>[<a class="code" href="classagg_1_1polyfill.html#o3">m_num_cells</a>] = 0;
00658 
00659         <a class="code" href="classagg_1_1polyfill.html#f0">cell_qsort</a>(<a class="code" href="classagg_1_1polyfill.html#o6">m_sorted_cells</a>, <a class="code" href="classagg_1_1polyfill.html#o3">m_num_cells</a>);
00660     }
00661 
00662 
00663 
00664 
00665     <font class="comment">//------------------------------------------------------------------------</font>
<a name="l00666"></a><a class="code" href="classagg_1_1polyfill.html#a7">00666</a>     <font class="keyword">const</font> cell* <font class="keyword">const</font>* polyfill::get_cells()
00667     {
00668         <font class="keywordflow">if</font>(<a class="code" href="classagg_1_1polyfill.html#o8">m_flags</a> &amp; <a class="code" href="namespaceagg.html#a57a1">not_closed</a>)
00669         {
00670             <a class="code" href="classagg_1_1polyfill.html#a6">line_to</a>(<a class="code" href="classagg_1_1polyfill.html#o13">m_close_x</a>, <a class="code" href="classagg_1_1polyfill.html#o14">m_close_y</a>);
00671             <a class="code" href="classagg_1_1polyfill.html#o8">m_flags</a> &amp;= ~<a class="code" href="namespaceagg.html#a57a1">not_closed</a>;
00672         }
00673 
00674         <font class="keywordflow">if</font>(<a class="code" href="classagg_1_1polyfill.html#o3">m_num_cells</a> == 0) <font class="keywordflow">return</font> 0;
00675 
00676         <font class="comment">//Perform sort only the first time.</font>
00677         <font class="keywordflow">if</font>(<a class="code" href="classagg_1_1polyfill.html#o8">m_flags</a> &amp; <a class="code" href="namespaceagg.html#a57a2">sort_required</a>)
00678         {
00679             <a class="code" href="classagg_1_1polyfill.html#c3">add_cur_cell</a>();
00680             <a class="code" href="classagg_1_1polyfill.html#c4">sort_cells</a>();
00681             <a class="code" href="classagg_1_1polyfill.html#o8">m_flags</a> &amp;= ~<a class="code" href="namespaceagg.html#a57a2">sort_required</a>;
00682         }
00683 
00684         <font class="keywordflow">return</font> <a class="code" href="classagg_1_1polyfill.html#o6">m_sorted_cells</a>;
00685     }
00686 
00687 
00688 
00689 
00690     <font class="comment">//------------------------------------------------------------------------</font>
<a name="l00691"></a><a class="code" href="classagg_1_1polyfill.html#a8">00691</a>     scanline* polyfill::get_scanline()
00692     {
00693         <font class="keywordflow">if</font>(<a class="code" href="classagg_1_1polyfill.html#o3">m_num_cells</a> == 0) <font class="keywordflow">return</font> 0;
00694         <a class="code" href="classagg_1_1polyfill.html#o17">m_scanline</a>.reset(<a class="code" href="classagg_1_1polyfill.html#o15">m_min_x</a>, <a class="code" href="classagg_1_1polyfill.html#o16">m_max_x</a>);
00695         <font class="keywordflow">return</font> &amp;<a class="code" href="classagg_1_1polyfill.html#o17">m_scanline</a>;
00696     };
00697 
00698 
00699 
00700 
00701 }
</pre></div><hr><address><small>Generated on Tue Apr 23 09:06:33 2002 for AGG v2.0 beta by
<a href="http://www.doxygen.org/index.html">
<img src="doxygen.gif" alt="doxygen" align="middle" border=0 
width=110 height=53></a>1.2.14 written by <a href="mailto:dimitri@stack.nl">Dimitri van Heesch</a>,
 &copy;&nbsp;1997-2002</small></address>
</body>
</html>
